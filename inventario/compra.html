<!DOCTYPE html><html><head>    <!--Import Google Icon Font-->    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">    <!--Import materialize.css-->    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection"/>    <title>compra</title>    <!--Let browser know website is optimized for mobile-->    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>    <style>        header, main, footer {            padding-left: 300px;        }        @media only screen and (max-width : 992px) {            header, main, footer {                padding-left: 0;            }        }    </style></head><body><div class="menuContainer"></div><main>    <h3>Compras</h3>    <div class="fixed-action-btn">        <a class="btn-floating btn-large waves-effect waves-light green modal-trigger z-depth-5 hoverable"           href="#modalAgregarCompra"><i                class="material-icons">add</i></a>    </div></main><!-- Modal para Crear --><div id="modalAgregarCompra" class="modal modal-fixed-footer">    <div class="modal-content">        <div class="row">            <h4 class="col l6">Agregar Compra</h4>        </div>        <!--         totalCompra        -->        <div class="row">            <div class="row">                <div class="input-field col s6">                    <label for="epFecha">Fecha</label>                    <input id="epFecha" type="text" class="date-button btn-default date-input form-control"/>                    <span class="input-group-btn">                        <!-- <button class="date-button btn btn-default" type="button"> @ </button> -->                    </span>                    <div id="date-picker"> </div>                </div>                <div class="input-field col s6">                    <input id="epFormaPago" type="text" class="validate">                    <label for="epFormaPago">Forma de pago</label>                </div>            </div>            <div class="row">                <div class="input-field col s6">                    <input id="epNumeroDocumeto" type="text" class="validate">                    <label for="epNumeroDocumeto">Número de documento</label>                </div>                <div class="input-field col s6">                    <input id="epTipoDocumento" type="text" class="validate">                    <label for="epTipoDocumento">Tipo de documento</label>                </div>            </div>            <div class="row">                <div id="proveedor"></div>                <div class="input-field col s6">                    <input id="epValorTotal" type="text" class="validate" value="0">                    <label for="epValorTotal">Valor total compra</label>                </div>            </div>            <div class="row">                <div class="card-panel white hoverable">                    <span>Detalle</span>                    <table id="detalle" class="highlight">                        <thead>                            <tr>                                <th>Código</th>                                <th>Descripción</th>                                <th>Cantidad</th>                                <th>Precio</th>                                <th>Valor</th>                            </tr>                        </thead>                        <tbody>                        </tbody>                    </table>                    <div class=" direction-top active">                        <a class="btn-floating btn-large waves-effect waves-light green" onclick="agregaColumna()"><i class="material-icons">add</i></a>                    </div>                </div>            </div>        </div>    </div>    <div class="modal-footer">        <a id="botonguardar" class="modal-action green modal-close waves-effect waves-green btn-flat">Guardar</a>    </div></div><!--JavaScript at end of body for optimized loading--><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script>    $(document).init(function () {        $('.menuContainer').load('./menu.html');    });</script><script type="text/javascript" src="js/materialize.min.js"></script><script type="text/javascript" src="js/pickadate.js"></script><!--editabletable--><script type="text/javascript" src="js/mindmup-editabletable.js"></script><script type="text/javascript" src="js/numeric-input-example.js"></script><link type="text/css" rel="stylesheet" href="css/pickadate.css" media="screen,projection" /><script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script><script src="https://www.gstatic.com/firebasejs/4.12.1/firebase-firestore.js"></script><script>    // Initialize Firebase    var config = {        apiKey: "AIzaSyAz2S2RPN4u0ijdHXfkgQXHnX4OAMvhy8M",        authDomain: "inventario-e01bb.firebaseapp.com",        databaseURL: "https://inventario-e01bb.firebaseio.com",        projectId: "inventario-e01bb",        storageBucket: "inventario-e01bb.appspot.com",        messagingSenderId: "249599638020"    };    firebase.initializeApp(config);    var db = firebase.firestore();</script><script>    firebase.auth().onAuthStateChanged(function (user) {        if (user) {            $("#botonguardar").click(function () {                var data = [];                var detalle = {};                $("#detalle").find('tr').each(function (rowIndex, r) {                    if (rowIndex > 0) {                        //var cols = [];                        $(this).find('th,td').each(function (colIndex, c) {                            if (colIndex == 0){                                var index = parseInt(rowIndex) -1;                                var id = "#idProducto"+index;                                var producto = $(id +" :selected").text();                                detalle['descripcion'] = producto;                                var codigo = $(id).val();                                detalle['codigo'] = codigo;                            }                            if (colIndex == 1){                                detalle['cantidad'] = c.textContent;                            }                            if (colIndex == 2){                                detalle['precio'] = c.textContent;                            }                            if (colIndex == 3){                                detalle['valor'] = c.textContent;                            }                        });                        data.push(detalle);                    }                });                var compra = {                    fecha: $("#epFecha").val(),                    formaPago: $("#epFormaPago").val(),                    numeroDocumento: $("#epNumeroDocumeto").val(),                    tipoDocumento: $("#epTipoDocumento").val(),                    totalCompra: $("#epValorTotal").val(),                    rutProveedor: $("#selectProveedor").val(),                    detalle: data                };                db.collection("Usuarios").doc(user.uid).collection("Compras").doc(compra.rutProveedor+compra.numeroDocumento+compra.tipoDocumento).set(compra);                M.toast({html: 'La compra se registro con éxito', classes: 'rounded green'});            });        }else {            //redireccionar a login            console.log("no existe usuario");        }    });    function agregaColumna(){        var idProducto = $('.producto').length;        var descripcionProducto =  "<div class=\"input-field col s12 l6\">" +            "<select class=\"producto\" id=\"idProducto"+idProducto+"\">" +            "<option value=\"0\" disabled selected>Selecciona un producto </option>";        firebase.auth().onAuthStateChanged(function (user) {            if (user) {                db.collection("Usuarios").doc(user.uid).collection("Productos").get().then((querySnapshot) => {                    querySnapshot.forEach((doc) => {                        // doc.data() is never undefined for query doc snapshots                        descripcionProducto = descripcionProducto + "<option value=" + doc.data().codigo + ">" + doc.data().descripcion + "</option>";                    });                    descripcionProducto = descripcionProducto + "</select>" +                    "</div>";                    $('#detalle tr:last').after('<tr>' +                        '<td class="codigo" onchange="editaCodigo(this, $(this).html())">Agregar codigo</td>' +                        '<td class="descripcion" onchange="editaDescripcion()">'+descripcionProducto+'</td>' +                        '<td class="cantidad">Agregar cantidad</td>' +                        '<td class="precio">Agregar precio</td>' +                        '<td class="valor" onchange="editaValor()">Agregar valor</td></tr>');                    $('#detalle').editableTableWidget();                    $('#detalle').editableTableWidget({                        cloneProperties: ['background', 'border', 'outline']                    });                    $('select').formSelect();                });            } else {                //redireccionar a login                console.log("no existe usuario");            }        });    }    // $("#detalle > tr > td .codigo").on("change",function () {    //     editaCodigo();    // });    //    // $("#detalle > tr > td .descripcion").on("change", function () {    //     editaDescripcion();    // });    // $("#detalle").on("change", function () {    //     alert("edita Valor");    // });    function editaValor(){        var valor = 0;        var codigoSeleccionado = 0;        $('#detalle tr').find(".valor").each(function () {            valor += parseInt($(this).html());            console.log("valor"+valor);        });        /* $('#detalle tr').find(".codigo").each(function () {             editaCodigo();         });         $('#detalle tr').find(".descripcion :selected").each(function () {             editaDetalle();         });*/        $("#epValorTotal").val(valor);    }    /*$("#detalle").on("change", function() {        $('#detalle tr').find(".codigo").each(function () {            var codigo = parseInt($(this).html());            firebase.auth().onAuthStateChanged(function (user) {                if (user) {                    db.collection("Usuarios").doc(user.uid).collection("Productos").get().then(function (querySnapshot) {                        querySnapshot.forEach(function (doc) {                            // doc.data() is never undefined for query doc snapshots                            var codigo = doc.data().codigo;                        });                        // $("#proveedor").append(html);                        // $('select').formSelect();                    });                }else {                    console.log("no existe usuario");                }            });        });    });*/    function getRowIndex (cell) {        return document.all ? cell.parentElement.rowIndex :            cell.parentNode.rowIndex;    }    function editaDescripcion(){        $('#detalle tr').find(".descripcion :selected").each(function () {            alert("edita Descripcion");            //valor = $(this).html();            //console.log("Valor: "+valor);            var codigo = $(this).val();            codigoSeleccionado = codigo;            console.log("codigoSeleccionado: "+codigoSeleccionado);            console.log("Codigo: "+codigo);            $('#detalle tr').find(".codigo").html(codigo);        });    }    function editaCodigo(cell, codigo){        $("#detalle option[value=" + codigo + "]").attr("selected", true);        $('select').formSelect();        var rowChaged = getRowIndex(cell);        alert(rowChaged);        $('#detalle tr').find(".codigo").html(codigo);    }    $( document ).ready(function() {        $('#detalle').editableTableWidget();        $('#detalle').editableTableWidget({            cloneProperties: ['background', 'border', 'outline']        });        firebase.auth().onAuthStateChanged(function (user) {            if (user) {                db.collection("Usuarios").doc(user.uid).collection("Proveedores").where("habilitado", "==", true).orderBy("rut").get().then(function (querySnapshot) {                    $("#cargandotabla").empty();                    var html =                        "<div class=\"input-field col s12 l6\">" +                        "<select class=\" \" id=\"selectProveedor\">" +                        "<option value=\"0\" disabled selected>Selecciona un proveedor </option>";                    querySnapshot.forEach(function (doc) {                        // doc.data() is never undefined for query doc snapshots                        var rut = doc.data().rut;                        var nombre = doc.data().nombre;                        html = html + " <option value=" + rut + ">" + nombre + "</option>";                    });                    html = html + "</select>" +                        "<label>Proveedor</label>" +                        "</div>";                    $("#proveedor").append(html);                    $('select').formSelect();                });            }else {                console.log("no existe usuario");            }        });    });</script></body></html>